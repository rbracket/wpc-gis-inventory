<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>WPC-GIS Curb Ramp Inventory App</title>
        <meta name="description" content="An app for use by the WPC GIS Jam group and volunteers for a curb ramp inventory in Portland, OR.">
        <meta name="author" content="Mele Sax-Barnett http://pdxmele.github.com/pdxmele">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

        <!--leaflet & jquery links-->
        <script src="http://cdn.leafletjs.com/leaflet-0.3.1/leaflet.js"></script>
        <script src="bing.js"></script>
        <script src="lvector.js"></script>
        <script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
        <script src="http://code.jquery.com/mobile/1.2.0-alpha.1/jquery.mobile-1.2.0-alpha.1.min.js"></script>
       
        <!-- styles -->
        <link rel="stylesheet" href="http://code.jquery.com/mobile/1.2.0-alpha.1/jquery.mobile-1.2.0-alpha.1.min.css" />
        <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.3.1/leaflet.css" />
        <!--[if IE]> <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.3.1/leaflet.ie.css" /> <![endif]-->

    <body>
        <div id="map"></div>
    </body>
 
    <!--my script-->
    <script type ="text/javascript">

    $(document).ready(function() {

        $.ajaxSetup({cache:false});
        $('#map').css('height', ($(window).height()));

        var map = new L.Map('map', {
            center: new L.LatLng(45.53266, -122.66002),
            zoom: 18
        });

        var bing = new L.BingLayer("Ao5Ew1XnxVey8Mh0jgfL32mbQN1pNLQoDv48u1r5BJrGsf8r0Bach7FYO5wTpbHl");

        var mapQuest = new L.TileLayer("http://{s}.mqcdn.com/tiles/1.0.0/osm/{z}/{x}/{y}.png", {
                maxZoom: 18,
                subdomains: ["otile1", "otile2", "otile3", "otile4"],
                attribution: 'Tiles Courtesy of <a href="http://www.mapquest.com/" target="_blank">MapQuest</a>. Map data (c) <a href="http://www.openstreetmap.org/" target="_blank">OpenStreetMap</a> contributors, CC-BY-SA.'
        });
        map.addLayer(mapQuest);

        var customMarker1 = L.Icon.extend({
            iconUrl: "img/y.png",
            shadowUrl: null,
            iconSize: new L.Point(16, 16),
            iconAnchor: new L.Point(8, 8),
            popupAnchor: new L.Point(1, -8)
        });

        var customMarker2 = L.Icon.extend({
            iconUrl: "img/n.png",
            shadowUrl: null,
            iconSize: new L.Point(16, 16),
            iconAnchor: new L.Point(8, 8),
            popupAnchor: new L.Point(1, -8)
        });

        //using leaflet vector layers plugin, most of code from examples. See http://geojason.info/leaflet-vector-layers
        var cartodb_layer = new lvector.CartoDB({
            user: "pdxmele",
            table: "corners",
            //map: map,
            //scaleRange: [16, 20],
            
            symbology: {
                type: "unique", // Defines the symbology as a unique type where features with an attribute of a specific value are symbolized the same way
                property: "evaluated", // The property (field, attribute) to use for defining unique values and styles
                values: [ // An array of values to set symbology. Each value has a specific symbology
                    {
                        value: "y", // If feature.properties.DISTRICT == "A"
                        vectorOptions: {
                            icon: new customMarker1("img/y.png")
                        }
                    },
                    {
                        value: "n",
                        vectorOptions: {
                            icon: new customMarker2("img/n.png")
                        }
                    }
                ]
            },
            dynamic: true,
            autoUpdate: true,
            autoUpdateInterval: 60000,
            popupTemplate: '<div style="text-align:center"><h4>Corner #<div id="c_id" style="display: inline">{id}</div> - <div id="c_dir" style="display: inline">{c_direct}</div> corner of<br/><div id="rt_nm" style="display: inline">{st_rt_nm}</div> and <div id="lf_nm" style="display: inline">{st_lf_nm}</div></h4></div><form name= "cornerForm"><p>Curb ramp for crossing to the {to_dir_a} corner?<br /><select name="aRamp"><option>Select</option><option value="y">yes</option><option value="n">no</option></select></p><p>Curb ramp for crossing to the {to_dir_b} corner?<br /><select name="bRamp"><option>Select</option><option value="y">yes</option><option value="n">no</option></select></p><p>Are the ramps textured?<br /><select name="texture"><option>Select</option><option value="y">yes</option><option value="n">no</option><option value="r">only for the first crossing</option><option value="l">only for the second crossing</option></select></p><p>Any potential problems with the following:<br /><select name="flags"><option select="">Select</option><option value="none">none</option><option value="safety">safety</option><option value="slope">slope</option><option value="drainage">drainage</option><option value="safety, slope">safety and slope</option><option value="safety, drainage">safety and drainage</option><option value="slope, drainage">slope and drainage</option><option value="safety, slope, drainage">safety, slope, and drainage</option></select></p><p>Ready to send? <input type="button" value="Submit" onClick="processCornerForm()" /></p></form></div>',
            singlePopup: true,
            popupOptions: {minWidth: 275, maxWidth: 275}
        });

        cartodb_layer.setMap(map);

        map.addControl(new L.Control.Layers({'MapQuest Open':mapQuest, "Bing Aerial":bing}, {}));
        
        /*various other optional location stuff from leaflet mobile example
        function onLocationFound(e) {
            var radius = e.accuracy / 2;
            L.marker(e.latlng).addTo(map)
                .bindPopup("You are within " + radius + " meters from this point").openPopup();
            L.circle(e.latlng, radius).addTo(map);
            }*/

        function onLocationError(e) {
            alert(e.message);
            }
        //map.on('locationfound', onLocationFound);
        map.on('locationerror', onLocationError);
        map.locate({setView: true, maxZoom: 18});

    });

    //this function sends the form info to CartoDB
    function processCornerForm() {

    //grab the information from the form
    var id = document.getElementById("c_id").innerHTML; //TODO: switch over to jQuery 
    var a_ramp = document.cornerForm.aRamp.value; //TODO: switch over to jQuery
    var b_ramp = document.cornerForm.bRamp.value; //TODO: switch over to jQuery
    var texture = document.cornerForm.texture.value; //TODO: switch over to jQuery
    var flags = document.cornerForm.flags.value; //TODO: switch over to jQuery

    //put together the query
    var query = "q=UPDATE corners SET evaluated = 'y', rramp = '"+a_ramp+"', lramp = '"+b_ramp+"', texture = '"+texture+"', flags = '"+flags+"' where id = '"+id+"'&api_key=df65312f62568527b7750a1266233be8a3d6c56c";
    //the above key is mine for the purposes of this test/dev site, you will get your own with your cartodb account
                    
    //for debugging
    //alert(query);
                    
    //post the query!
    $.post("http://pdxmele.cartodb.com/api/v2/sql", query, alert ("Successfully posted to database"));

    //close the popup -- the old way, no longer works. TODO: find a new way to auto-close popup
    //$('#myPopup').popup("close");
    //location.reload(); -- works to close popup, but screws up auto-update and submit?
            
    return;
    }
    
    </script>

</html>